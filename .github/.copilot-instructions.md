# GitHub Copilot Instructions for WorkMood

## Quick Reference

### Project Context
**WorkMood** - Cross-platform desktop mood tracking application
- **.NET 9.0 MAUI** (Windows/macOS only, no mobile)
- **4-project solution**: Main app, Tests, Version library, Version tests
- **Current Version**: 0.3.0 | **App ID**: `com.workmood.mauiapp`

### Essential Commands
```bash
# Build (specify framework)
dotnet build --framework net9.0-windows10.0.19041.0

# Run application  
dotnet run --project MauiApp/WorkMood.MauiApp.csproj --framework net9.0-windows10.0.19041.0

# Test everything
dotnet test

# Documentation setup
npm install
```

### Commit Pattern (MANDATORY)
**Format**: `[Risk][Intention] - [Description]`
- `^r` - Validated refactoring (most common)
- `^f` - Internal feature | `^F` - User feature  
- `^b` - Internal bugfix | `^B` - User bugfix
- `^d` - Documentation changes

---

## When Creating Code

### Architecture Requirements
**MAUI MVVM Clean Architecture** - All code must follow:
- **MVVM Pattern**: ViewModels (no direct UI), Views (XAML), Models (data)
- **Dependency Injection**: Constructor injection for all services
- **Interface Segregation**: Services behind interfaces (`I[ServiceName]`)
- **Nullable Reference Types**: Enabled project-wide

### Folder Structure (Mirror in tests)
```
MauiApp/
├── ViewModels/          # MVVM ViewModels  
├── Services/            # Business logic interfaces & implementations
├── Models/              # Data models and DTOs
├── Pages/               # XAML views and code-behind
├── Shims/               # Dependency abstractions (Shim Factory Pattern)
├── Infrastructure/      # Base classes, utilities, commands
├── Converters/          # XAML value converters
├── Strategies/          # Strategy pattern implementations  
├── Processors/          # Data processing logic
├── Graphics/            # Custom drawing (SkiaSharp)
├── Adapters/            # Data transformation
└── Factories/           # Object creation patterns
```

### Key Service Interfaces
**Core Services** (use these interfaces):
- `IMoodDataService` - Mood data CRUD operations
- `IMoodVisualizationService` - Graph generation and visualization  
- `ILineGraphService` - SkiaSharp line graph rendering
- `IScheduleConfigService` - Reminder scheduling and configuration
- `INavigationService` - Page routing and navigation
- `IDataArchiveService` - Backup and data export
- `ILoggingService` - Application diagnostics and logging

**Shim Abstractions** (already implemented):
- File System: `IFileShim`, `IFolderShim`, `IFileShimFactory`
- Drawing: `IPaintShim`, `IColorShim`, `IPathEffectShim` (see `DrawingShims.cs`)
- Utilities: `IDateShim`, `IJsonSerializerShim`, `IBrowserShim`

---

## When Building & Testing

### Framework Targeting (CRITICAL)
**Always specify target framework** - MAUI requires explicit targeting:

```bash
# Windows (primary development)
dotnet build --framework net9.0-windows10.0.19041.0
dotnet run --project MauiApp/WorkMood.MauiApp.csproj --framework net9.0-windows10.0.19041.0

# macOS (cross-platform)  
dotnet build --framework net9.0-maccatalyst
dotnet publish --framework net9.0-maccatalyst

# Solution-wide operations
dotnet build WorkMood.sln           # All projects
dotnet test                         # All tests
dotnet watch run --project WorkMood.sln  # Watch mode
```

### Testing Strategy
```bash
# Run specific test projects
dotnet test WorkMood.MauiApp.Tests/WorkMood.MauiApp.Tests.csproj
dotnet test whats-your-version-tests/whats-your-version-tests.csproj

# Test with coverage (when available)
dotnet test --collect:"XPlat Code Coverage"
```

**Test Organization**:
- Mirror main project structure in test projects
- Use `TestHelpers/` for shared test utilities
- Mock external dependencies via Shim abstractions
- Focus on ViewModels and Services (not UI directly)

---

## When Refactoring (Shim Factory Pattern)

### Refactoring Philosophy
**Disciplined Incremental Refactoring** - Safety and testability first
- **ONE method at a time** - Never batch refactor multiple methods
- **Manual verification** - Test after each change (ask user to verify)
- **Small commits** - One concept per commit with Arlo's notation
- **Preserve behavior** - Zero functional changes during refactoring

### Shim Factory Implementation Process

#### Phase 1: Infrastructure (if not exists)
1. Create `I[Type]Shim` interface for dependency type
2. Create `[Type]Shim` concrete implementation  
3. Create `I[Type]ShimFactory` factory interface
4. Create `[Type]ShimFactory` factory implementation
5. Update service constructors for factory injection

#### Phase 2: Method-by-Method Refactoring  
**CRITICAL SEQUENCE** (repeat for each method):
1. **Add Factory Method** - Extend factory interface
2. **Implement Factory Method** - Add concrete implementation
3. **Refactor Target Method** - Replace direct usage with factory calls
4. **Manual Test** - Verify identical behavior (user confirms)
5. **Commit** - `^r - extract [MethodName] to use [dependency] factory for dependency injection`
6. **Next Method** - Continue systematically

### Existing Shim Abstractions
**File System Shims** (implemented):
- `IFileShim`/`FileShim` + `IFileShimFactory`/`FileShimFactory`
- `IFolderShim`/`FolderShim` - Directory operations

**Drawing Shims** (SkiaSharp - implemented in `DrawingShims.cs`):
- `IPaintShim`/`PaintShim` with `PaintShimArgs` 
- `IColorShim`, `ITypeFaceShim`, `IPathEffectShim`
- Canvas and drawing operation abstractions

**Utility Shims** (implemented):
- `IDateShim`/`DateShim`, `IJsonSerializerShim`/`JsonSerializerShim`
- `IBrowserShim`/`BrowserShim`

### Refactoring Targets by Priority
1. **High Impact**: File I/O (`File.WriteAllBytesAsync`), Object creation (`new SKBitmap()`), Constants (`SKColors.White`)
2. **Medium Impact**: Path effects, paint styles, image encoding
3. **Lower Impact**: Geometric objects, async patterns

### Anti-Patterns to Avoid
❌ **Big Bang Refactoring** - Multiple methods simultaneously
❌ **Batch Commits** - Multiple method refactors in one commit  
❌ **Breaking Changes** - Altering public APIs during internal refactoring
❌ **Skip Testing** - Committing without manual verification

---

## When Committing Code

### Arlo's Commit Notation (MANDATORY)
**Format**: `[Risk][Intention] - [Description]`

#### Risk Assessment
- **`.`** (Safe) - Automated refactoring tools OR test-supported procedural with full coverage
- **`^`** (Validated) - Manual changes with adequate test coverage and manual verification  
- **`!`** (Risky) - Manual changes with limited test coverage but following established patterns
- **`@`** (Broken) - Code doesn't compile, tests fail, or functionality incomplete

#### Intentions
- **`r`** - Refactoring (no behavior change) 
- **`f`** - Internal feature | **`F`** - User-visible feature
- **`b`** - Internal bugfix | **`B`** - User-visible bugfix  
- **`d`** - Documentation changes
- **`t`** - Tests only (new or modified tests)

#### Common Commit Examples
```bash
# Refactoring (most common)
^r - extract DrawBackground to use color factory for dependency injection
^r - remove SKCanvas overloads and use drawShimFactory for object creation
.r - extract method using automated refactoring tool

# Features & Fixes
^f - add new internal API method for graph data processing
^b - fix null reference in data validation logic  
^B - fix user-visible crash when loading invalid mood data
^F - add new user dashboard feature (manual testing only)

# Documentation
^d - update architecture documentation for shim factory pattern
^d - add maintenance guidelines for copilot instructions
```

### Quality Gates Before Commit
✅ **Build succeeds** without errors  
✅ **Tests pass** (automated + manual verification when needed)
✅ **Single responsibility** - One method/concept per commit
✅ **Behavior preserved** - No functional changes during refactoring
✅ **Risk assessed** - Appropriate risk level assigned

### Ensuring Arlo's Commit Notation in VS Code

**❌ VS Code "Generate Commit Message" Limitation**: The built-in generate feature doesn't automatically follow local templates or project-specific notation.

**✅ Recommended Approaches**:

1. **GitHub Copilot Chat Method (Most Effective)**:
   - Use `Ctrl+Shift+I` or open Copilot Chat
   - Ask: "Generate a commit message using Arlo's Commit Notation for my staged changes"
   - Copilot will use the instructions in `.github/.copilot-instructions.md`

2. **Manual Template Reference**:
   - Git template (`.gitmessage`) shows in commit dialog as comments
   - Use as reference while typing commit messages manually

3. **PowerShell Helper** (Fastest for common patterns):
   - Source `commit-helper.ps1` for command shortcuts
   - `arlorefactor "description"` - Quick `^r` commits
   - `arlofeat "description"` - Quick `^f` commits  
   - `arlodoc "description"` - Quick `^d` commits
   - `Show-ArloNotation` - Display notation reference

4. **VS Code Snippets**: 
   - Type `^r`, `^f`, `^d`, etc. in commit input for autocomplete
   - Available in `.vscode/commit-message.code-snippets`

**Best Practice**: Use Copilot Chat for commit generation rather than the built-in "Generate Commit Message" button to ensure Arlo's notation compliance.

---

## When Updating Instructions  

### Maintenance Triggers
Update `.github/.copilot-instructions.md` when making changes that affect:

1. **Project Structure** - Adding/removing projects, new folders, framework changes
2. **Service Architecture** - New services, interface changes, DI patterns  
3. **Build Process** - New commands, target frameworks, testing procedures
4. **Development Workflow** - Tools, dependencies, refactoring patterns, commit conventions

### Update Process
- **Immediate Updates** - Include instruction updates in the same commit as structural changes
- **Commit Pattern** - `^d - update copilot instructions for [specific change]`  
- **Validation** - Ensure instructions match actual project state, not intended state
- **Periodic Reviews** - Quarterly review for accuracy and completeness

### Responsibility  
- **Contributors** - Check if changes impact instructions
- **Maintainers** - Validate instruction accuracy during code reviews
- **GitHub Copilot** - Proactively suggest updates when detecting mismatches

---

## Platform & Environment Details

### Target Frameworks & Requirements
- **Windows**: `net9.0-windows10.0.19041.0` (Min: Windows 10 v1809)
- **macOS**: `net9.0-maccatalyst` (Min: macOS 15.0 Monterey, x64/ARM64)
- **Language**: C# with nullable reference types enabled
- **UI**: XAML with compiled bindings enabled

### Dependencies & Tools
- **Primary**: .NET 9.0 MAUI, SkiaSharp for graphics  
- **Documentation**: Node.js + Doculisp (`npm install`)
- **Version Utility**: `whats-your-version` library with build date attribution
- **Testing**: xUnit (standard .NET testing)

### Application Metadata
- **Name**: "WorkMood - Daily Mood Tracker"  
- **ID**: `com.workmood.mauiapp` 
- **Version**: 0.3.0 (ApplicationVersion: 4)
- **Icon**: `smiles.ico` (root), `Resources/AppIcon/smiles.png` (MAUI)
- **Scope**: Desktop-only work mood tracking, local storage, no cloud services

---

## Code Transformation Examples

### Before (Hard Dependency):
```csharp
private void DrawBackground(SKCanvas canvas, SKRect area)
{
    using var backgroundPaint = new SKPaint
    {
        Color = SKColors.White,  // Hard-coded dependency
        Style = SKPaintStyle.Fill
    };
    canvas.DrawRect(area, backgroundPaint);
}
```

### After (Factory Pattern):
```csharp
private void DrawBackground(SKCanvas canvas, SKRect area)
{
    DrawBackground(drawShimFacory.From(canvas), area);
}

private void DrawBackground(ICanvasShim canvas, SKRect area)
{
    using var backgroundPaint = drawShimFactory.PaintFromArgs(new PaintShimArgs
    {
        Color = drawShimFactory.WhiteColor(),  // Factory-created dependency
        Style = SKPaintStyle.Fill
    });
    canvas.DrawRect(area, backgroundPaint);
}
```

---

## Historical Reference & Success Metrics

### Example Refactoring Session
**Reference Implementation**: Commits `6d7b2feb687d49cec0f8c2b736b310c7919e1c6d` through `e7c36441de989f5280458d364c180c0c762c10d4` applied to `LineGraphService.cs`

**Success Metrics Achieved**:
- 20+ individual commits over 2 days  
- Zero breaking changes to functionality
- Complete SkiaSharp abstraction achieved
- 100% manual test coverage between commits
- Clear, traceable commit history

*This methodology prioritizes **safety, testability, and maintainability** over speed. The investment in disciplined refactoring pays dividends in code quality and development velocity.*

---

## Response Guidelines for GitHub Copilot

**When responding, always:**
- Use Arlo's Commit Notation format when suggesting commits
- Include risk assessment reasoning for commit suggestions
- **Proactively check instruction accuracy** - suggest updates when detecting project changes
- **Flag mismatches** - alert if project state differs from documented instructions  
- **Suggest instruction updates** when making structural changes
- Consider MVVM compliance, service injection, platform requirements, data binding, MAUI lifecycle
- End responses with 🤖 to indicate use of this context

**Action-oriented priorities:**
1. **Creating Code** → Architecture patterns, existing services, shim abstractions
2. **Building/Testing** → Framework targeting, test organization, quality gates
3. **Refactoring** → Incremental methodology, shim factory pattern, commit discipline  
4. **Committing** → Arlo's notation, risk assessment, single responsibility
5. **Maintaining** → Instruction updates, project synchronization