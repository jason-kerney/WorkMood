<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="WorkMood.MauiApp.Pages.Graph"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:WorkMood.MauiApp.Models"
             xmlns:viewmodels="clr-namespace:WorkMood.MauiApp.ViewModels"
             x:DataType="viewmodels:GraphViewModel"
             Title="Mood Graph">
    
    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        
        <!-- Date Range Selection -->
        <StackLayout Grid.Row="0" Orientation="Vertical" Spacing="10" Margin="0,0,0,20">
            <!-- First row: Date Range and Options -->
            <StackLayout Orientation="Horizontal" Spacing="10">
                <Label Text="Date Range:" VerticalOptions="Center" />
                <Picker x:Name="DateRangePicker"
                        ItemsSource="{Binding DateRanges}"
                        SelectedItem="{Binding SelectedDateRange}"
                        ItemDisplayBinding="{Binding DisplayName}"
                        VerticalOptions="Center"
                        MinimumWidthRequest="200" />
                <CheckBox IsChecked="{Binding ShowDataPoints}"
                          VerticalOptions="Center"
                          Margin="20,0,0,0" />
                <Label Text="Show Data Points"
                       VerticalOptions="Center"
                       Margin="5,0,0,0" />
                <CheckBox IsChecked="{Binding ShowAxesAndGrid}"
                          VerticalOptions="Center"
                          Margin="20,0,0,0" />
                <Label Text="Show Axes &amp; Grid"
                       VerticalOptions="Center"
                       Margin="5,0,0,0" />
                <CheckBox IsChecked="{Binding ShowTitle}"
                          VerticalOptions="Center"
                          Margin="20,0,0,0" />
                <Label Text="Show Title"
                       VerticalOptions="Center"
                       Margin="5,0,0,0" />
            </StackLayout>
            
            <!-- Second row: Color Picker -->
            <StackLayout Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                <Label Text="Line Color:" VerticalOptions="Center" />
                <Border Stroke="Gray"
                        StrokeThickness="1"
                        BackgroundColor="{Binding SelectedLineColor}"
                        WidthRequest="30"
                        HeightRequest="30"
                        VerticalOptions="Center">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleColorPickerCommand}" />
                    </Border.GestureRecognizers>
                </Border>
                <Label Text="Tap to change color"
                       VerticalOptions="Center"
                       TextColor="Gray"
                       FontSize="12"
                       Margin="5,0,0,0" />
            </StackLayout>
            
            <!-- Inline Color Picker (Expandable) -->
            <StackLayout IsVisible="{Binding IsColorPickerVisible}" 
                        Orientation="Vertical" 
                        Spacing="10" 
                        Margin="0,10,0,0"
                        BackgroundColor="LightGray"
                        Padding="15">
                <Label Text="Choose a color:" FontAttributes="Bold" />
                
                <!-- Color Grid -->
                <FlexLayout Direction="Row" 
                           Wrap="Wrap" 
                           JustifyContent="Start"
                           AlignItems="Start">
                    <!-- First Row of Colors -->
                    <Border BackgroundColor="Blue" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Blue" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Red" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Red" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Green" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Green" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Orange" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Orange" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Purple" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Purple" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Brown" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Brown" />
                        </Border.GestureRecognizers>
                    </Border>
                    
                    <!-- Second Row of Colors -->
                    <Border BackgroundColor="Pink" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Pink" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Cyan" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Cyan" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Magenta" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Magenta" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="Yellow" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="Yellow" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="LimeGreen" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="LimeGreen" />
                        </Border.GestureRecognizers>
                    </Border>
                    <Border BackgroundColor="DarkBlue" Stroke="Gray" StrokeThickness="1" WidthRequest="40" HeightRequest="40" Margin="5">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SelectColorCommand}" CommandParameter="DarkBlue" />
                        </Border.GestureRecognizers>
                    </Border>
                </FlexLayout>
                
                <!-- Custom RGB Color Picker Section -->
                <Label Text="Custom Color:" FontAttributes="Bold" Margin="0,15,0,5" />
                
                <!-- Color Preview -->
                <Border BackgroundColor="{Binding SelectedLineColor}" 
                        Stroke="Gray" 
                        StrokeThickness="2" 
                        WidthRequest="50" 
                        HeightRequest="30" 
                        HorizontalOptions="Center" 
                        Margin="0,0,0,10" />
                
                <!-- RGB Sliders -->
                <Grid ColumnDefinitions="30,*,50" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                    <!-- Red Slider -->
                    <Label Grid.Row="0" Grid.Column="0" Text="R:" VerticalOptions="Center" TextColor="Red" FontAttributes="Bold" />
                    <Slider Grid.Row="0" Grid.Column="1" 
                            Minimum="0" Maximum="255" 
                            Value="{Binding RedValue, Mode=TwoWay}"
                            ThumbColor="Red"
                            MinimumTrackColor="Red" />
                    <Label Grid.Row="0" Grid.Column="2" Text="{Binding RedValue, StringFormat='{0:F0}'}" VerticalOptions="Center" />
                    
                    <!-- Green Slider -->
                    <Label Grid.Row="1" Grid.Column="0" Text="G:" VerticalOptions="Center" TextColor="Green" FontAttributes="Bold" />
                    <Slider Grid.Row="1" Grid.Column="1" 
                            Minimum="0" Maximum="255" 
                            Value="{Binding GreenValue, Mode=TwoWay}"
                            ThumbColor="Green"
                            MinimumTrackColor="Green" />
                    <Label Grid.Row="1" Grid.Column="2" Text="{Binding GreenValue, StringFormat='{0:F0}'}" VerticalOptions="Center" />
                    
                    <!-- Blue Slider -->
                    <Label Grid.Row="2" Grid.Column="0" Text="B:" VerticalOptions="Center" TextColor="Blue" FontAttributes="Bold" />
                    <Slider Grid.Row="2" Grid.Column="1" 
                            Minimum="0" Maximum="255" 
                            Value="{Binding BlueValue, Mode=TwoWay}"
                            ThumbColor="Blue"
                            MinimumTrackColor="Blue" />
                    <Label Grid.Row="2" Grid.Column="2" Text="{Binding BlueValue, StringFormat='{0:F0}'}" VerticalOptions="Center" />
                </Grid>
                
                <Button Text="Close" 
                        Command="{Binding ToggleColorPickerCommand}"
                        BackgroundColor="Gray"
                        TextColor="White"
                        WidthRequest="100"
                        HorizontalOptions="Center" 
                        Margin="0,10,0,0" />
            </StackLayout>
        </StackLayout>
        
        <!-- Custom Background Controls -->
        <StackLayout Grid.Row="1" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
            <Button Text="Load Background"
                    Command="{Binding LoadCustomBackgroundCommand}"
                    BackgroundColor="Purple"
                    TextColor="White"
                    HorizontalOptions="Start" />
            <Button Text="Clear Background"
                    Command="{Binding ClearCustomBackgroundCommand}"
                    BackgroundColor="Gray"
                    TextColor="White"
                    HorizontalOptions="Start"
                    IsVisible="{Binding HasCustomBackground}" />
            <Label Text="Custom Background Loaded"
                   VerticalOptions="Center"
                   TextColor="Purple"
                   FontAttributes="Bold"
                   IsVisible="{Binding HasCustomBackground}" />
        </StackLayout>
        
        <!-- Graph Display -->
        <Border Grid.Row="2"
                Stroke="Gray"
                StrokeThickness="1"
                BackgroundColor="White"
                Padding="10"
                Margin="0,10">
            <ScrollView>
                <Image Source="{Binding GraphImageSource}"
                       Aspect="AspectFit"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       HeightRequest="400"
                       WidthRequest="{Binding DisplayWidth}"
                       IsVisible="{Binding HasGraphData}" />
            </ScrollView>
        </Border>
        
        <!-- No Data Message -->
        <Label Grid.Row="2"
               Text="No mood data available for the selected period"
               FontSize="16"
               TextColor="Gray"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               IsVisible="{Binding HasNoData}" />
        
        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="2"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="Blue"
                          HorizontalOptions="Center"
                          VerticalOptions="Center" />
        
        <!-- Action Buttons -->
        <StackLayout Grid.Row="3" Orientation="Horizontal" Spacing="20" Margin="0,20,0,0">
            <Button Text="Export PNG"
                    Command="{Binding ExportGraphCommand}"
                    BackgroundColor="DarkBlue"
                    TextColor="White"
                    HorizontalOptions="Start" />
            <Button Text="Share Graph"
                    Command="{Binding ShareGraphCommand}"
                    BackgroundColor="Green"
                    TextColor="White"
                    HorizontalOptions="Start" />
            <Label Text="{Binding StatusMessage}"
                   VerticalOptions="Center"
                   TextColor="DarkGreen"
                   IsVisible="{Binding HasStatusMessage}" />
        </StackLayout>
        
    </Grid>
</ContentPage>